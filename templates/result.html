<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Anamnese-Ergebnis</title>
  <style>
    /* Schiebt ein Element in .btn-row nach rechts */
    .push-right { margin-left: auto; }

    /* (optional) sorgt daf√ºr, dass das Formular keinen Zeilenumbruch erzeugt */
    .actions form { display: inline-block; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      background-color: #f5f7fa;
    }

    .sidebar {
      width: 220px;
      background-color: #dfe6ec;
      padding: 20px;
      height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .sidebar h3 {
      margin-top: 0;
    }

    .sidebar a {
      display: block;
      margin: 8px 0;
      color: #007acc;
      text-decoration: none;
    }

    .sidebar a:hover {
      text-decoration: underline;
    }

    .main {
      flex-grow: 1;
      padding: 40px;
    }

    h2 {
      color: #2c3e50;
    }

    .section {
      background: #ffffff;
      border: 1px solid #dbe3ec;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }

    .section h3 {
      margin: 0 0 8px 0;
      color: #2c3e50;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
      border-radius: 8px;
      border: 1px solid #cfd8e3;
      background-color: #fff;
      resize: vertical;
      box-sizing: border-box;
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-primary {
      background-color: #28a745;
    }
    .btn-primary:hover {
      background-color: #218838;
    }

    .btn-secondary {
      background-color: #007acc;
    }
    .btn-secondary:hover {
      background-color: #005fa3;
    }

    .btn-outline {
      background: #ffffff;
      color: #2c3e50;
      border: 1px solid #cfd8e3;
    }
    .btn-outline:hover {
      background: #f1f5fb;
    }

    .info {
      color: green;
      margin-top: 10px;
    }

    .links {
      margin-top: 20px;
    }
    .result-bar{
        display:flex;
        align-items:center;
        gap:.75rem;
        padding:.5rem 0;
    }
    .result-bar .actions{ margin-left:auto; }  /* schiebt alles in      .actions nach rechts */
    .btn-danger{
        background:#d9534f; color:#fff; border:0; padding:.5rem .75rem; border-radius:.375rem; cursor:pointer;
    }
    .btn-danger:hover{ filter:brightness(.95); }
    .file-label{
      font-weight: 600;
      font-size: .95rem;
      color: #6b7b8a;
      margin-left: .5rem;
    }
    .file-meta{
      font-weight: 500;
      font-size: .95rem;
      color: #96a3af;
      margin-left: .45rem;
    }
  </style>
</head>
<body style="display: flex;">

  {% include "sidebar.html" %}

  <div class="main" style="margin-left: 220px;">
    {% set base   = filename.replace('_anamnese.txt','') if filename else '' %}
    {% set parts  = base.split('_') if base else [] %}
    {% set inits  = parts[0] if parts|length > 0 else '' %}
    {% set pnr    = parts[1] if parts|length > 1 else '' %}
    {% set ymd    = parts[2] if parts|length > 2 else '' %}   {# z.B. 20250922 #}
    {% set hms    = parts[3] if parts|length > 3 else '' %}   {# z.B. 213800   #}

    {# Kurzlabel wie in der Sidebar, z.B. X.X. 999999 #}
    {% set label  = (inits[0] ~ '.' ~ inits[1] ~ '. ' ~ pnr) if inits|length >= 2 and pnr else '' %}

    {# Datum/Uhrzeit formatiert: 22.09.2025 21:38 Uhr #}
    {% set date_str = (ymd[6:8] ~ '.' ~ ymd[4:6] ~ '.' ~ ymd[0:4]) if ymd|length == 8 else '' %}
    {% set time_str = (hms[0:2] ~ ':' ~ hms[2:4] ~ ' Uhr') if hms|length >= 4 else '' %}

    <h2>
      ü©∫ Ergebnis
      {% if label %}<span class="file-label">{{ label }}</span>{% endif %}
      {% if date_str %}<span class="file-meta">{{ date_str }} {{ time_str }}</span>{% endif %}
    </h2>

    <!-- Versteckte Original-Ausgabe (f√ºr initiales Parsen) -->
    <textarea id="rawAnamnese" style="display:none;">{{ anamnese }}</textarea>

    <!-- Unsichtbarer Dialogtext f√ºr Mitspeichern -->
    
    {% if dialog %}
      <textarea id="dialogText" style="display:none;">{{ dialog }}</textarea>
    {% endif %}

    <!-- Abschnitt: Anamnese -->
    <div class="section">
      <h3>Anamnese</h3>
      <textarea id="fldAnamnese" placeholder="Anamnese-Inhalt ‚Ä¶"></textarea>
      <div class="btn-row">
        <button class="btn-secondary" type="button" onclick="copyField('fldAnamnese')">üìã In Zwischenablage kopieren</button>
        <!-- im Anamnese-Block in der btn-row -->
        <button class="btn-primary" type="button"
                onclick="sendToT2medFrom('fldAnamnese')">üîÅ Nach T2med einf√ºgen</button>
        <button class="btn-outline" type="button" onclick="clearField('fldAnamnese')">üßπ Leeren</button>
      </div>
    </div>

    <!-- Abschnitt: Befund -->
    <div class="section">
      <h3>Befund</h3>
      <textarea id="fldBefund" placeholder="Befund-Inhalt ‚Ä¶"></textarea>
      <div class="btn-row">
        <button class="btn-secondary" type="button" onclick="copyField('fldBefund')">üìã In Zwischenablage kopieren</button>
        <button class="btn-primary" type="button"
                onclick="sendToT2medMode('fldBefund','befund')">üîÅ Nach T2med einf√ºgen</button>
        <button class="btn-outline"   type="button" onclick="clearField('fldBefund')">üßπ Leeren</button>
      </div>
    </div>

    <!-- Abschnitt: Therapie -->
    <div class="section">
      <h3>Therapie</h3>
      <textarea id="fldTherapie" placeholder="Therapie-Inhalt ‚Ä¶"></textarea>
      <div class="btn-row">
        <button class="btn-secondary" type="button" onclick="copyField('fldTherapie')">üìã In Zwischenablage kopieren</button>
        <button class="btn-primary" type="button"
                onclick="sendToT2medMode('fldTherapie','therapie')">üîÅ Nach T2med einf√ºgen</button>
        <button class="btn-outline"   type="button" onclick="clearField('fldTherapie')">üßπ Leeren</button>
      </div>
    </div>

    <!-- Globale Aktionen -->
    <div class="btn-row">
      <button class="btn-secondary" type="button" onclick="copyAll()">üìã Alles kopieren</button>
      <button class="btn-primary"   type="button" onclick="saveAll()">üíæ Speichern</button>

      <div class="actions push-right">
        {% if filename %}
        <form method="POST" action="{{ url_for('delete_record') }}"
              onsubmit="return confirm('Diese Analyse inkl. Dateien wirklich l√∂schen?');">
          <input type="hidden" name="basename" value="{{ filename.replace('_anamnese.txt','') }}">
          <button type="submit" class="btn-danger">üóëÔ∏è L√∂schen</button>
        </form>
        {% endif %}
      </div>
    </div>

    
    <!-- Feedback-Nachricht -->
    <p id="saveInfo" class="info" style="display: none;">‚úÖ Gespeichert</p>

    <!-- Zur√ºcklinks -->
    <div class="links">
      <a href="/">‚¨Ö Zur√ºck zur Startseite</a> |
      <a href="{{ url_for('admin_view', filename=filename) }}">‚öôÔ∏è Zur Admin-Ansicht</a>
    </div>
  </div>

  <script>
    // --- Parser: vorhandenen Gesamttext (mit √úberschriften) in die 3 Felder aufteilen
    function parseSections(text) {
      // Robust gegen Gro√ü-/Kleinschreibung und optionale Leerzeichen
      const pattern = /(?:^|\n)\s*Anamnese\s*:\s*([\s\S]*?)(?=\n\s*Befund\s*:|\n\s*Therapie\s*:|$)|(?:^|\n)\s*Befund\s*:\s*([\s\S]*?)(?=\n\s*Therapie\s*:|$)|(?:^|\n)\s*Therapie\s*:\s*([\s\S]*$)/gi;

      let anam = "", bef = "", ther = "";
      // Wir scannen abschnittsweise, da der Regex gruppenweise matcht
      // Alternative Vorgehensweise: gezielt splitten:
      const norm = (text || "").replace(/\r/g, "");
      // Greife die drei Abschnitte mit einfachen Splits
      // 1) Anamnese
      let aMatch = norm.match(/Anamnese\s*:\s*([\s\S]*?)(?=\n\s*Befund\s*:|\n\s*Therapie\s*:|$)/i);
      if (aMatch) anam = aMatch[1].trim();

      // 2) Befund
      let bMatch = norm.match(/Befund\s*:\s*([\s\S]*?)(?=\n\s*Therapie\s*:|$)/i);
      if (bMatch) bef = bMatch[1].trim();

      // 3) Therapie
      let tMatch = norm.match(/Therapie\s*:\s*([\s\S]*$)/i);
      if (tMatch) ther = tMatch[1].trim();

      return { anam, bef, ther };
    }

    function composeAll(anam, bef, ther) {
      // Striktes, backend-kompatibles Format
      const parts = [];
      parts.push("Anamnese: " + (anam || "‚Äî").trim());
      parts.push("Befund: " + (bef || "‚Äî").trim());
      parts.push("Therapie: " + (ther || "‚Äî").trim());
      return parts.join("\n");
    }

    function copyField(id) {
      const el = document.getElementById(id);
      if (!el) return;
      navigator.clipboard.writeText(el.value || "");
    }

    function clearField(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.value = "";
    }

    function copyAll() {
      const a = document.getElementById("fldAnamnese").value.trim();
      const b = document.getElementById("fldBefund").value.trim();
      const t = document.getElementById("fldTherapie").value.trim();
      const all = composeAll(a, b, t);
      navigator.clipboard.writeText(all);
    }

    function saveAll() {
      const a = document.getElementById("fldAnamnese").value.trim();
      const b = document.getElementById("fldBefund").value.trim();
      const t = document.getElementById("fldTherapie").value.trim();
      const combined = composeAll(a, b, t);

      const dialogText = document.getElementById("dialogText") ? document.getElementById("dialogText").value.trim() : "";
      const filename = "{{ filename }}";

      const formData = new FormData();
      formData.append("anamnese", combined); // Backend erwartet "anamnese": wir liefern die 3 Abschnitte zusammen
      formData.append("dialog", dialogText);
      formData.append("filename", filename);

      fetch("/save_anamnese", {
        method: "POST",
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          const info = document.getElementById("saveInfo");
          info.style.display = "block";
          setTimeout(() => { info.style.display = "none"; }, 3000);
        } else {
          alert("‚ùå Fehler beim Speichern.");
        }
      })
      .catch(err => {
        console.error("Speicherfehler:", err);
        alert("‚ùå Fehler beim Speichern.");
      });
    }

    // --- Initial: vorhandenen Text auf Felder verteilen
    (function init() {
      const raw = document.getElementById("rawAnamnese")?.value || "";
      const { anam, bef, ther } = parseSections(raw);
      document.getElementById("fldAnamnese").value = anam || "";
      document.getElementById("fldBefund").value   = bef  || "";
      document.getElementById("fldTherapie").value = ther || "";
    })();

      
      async function sendToT2medMode(textareaId, mode){
        const el  = document.getElementById(textareaId);
        const txt = (el?.value || '').trim();
        if (!txt) { alert('Kein Text.'); return; }

        // Neue Bridge-Methode: paste_to_t2med_mode(text, mode, window_title?)
        if (window.pywebview?.api?.paste_to_t2med_mode) {
          try {
            const res = await window.pywebview.api.paste_to_t2med_mode(txt, mode, 'T2med');
            if (!res || !res.ok) {
              const msg = res && res.error ? res.error : 'unbekannt';
              alert('Native Steuerung fehlgeschlagen: ' + msg);
            }
          } catch(e) {
            alert('Native Steuerung Fehler: ' + (e.message || e));
          }
        } else {
          // Fallback-Hinweis, falls alte Client-Version ohne die neue Methode
          alert('Diese Funktion erfordert die aktuelle Aurica Client-App.');
        }
      }
      // Zeigt an, wenn die pywebview Bridge bereit ist
       window.addEventListener('pywebviewready', function () {
         console.log('[Aurica] pywebview ready');
         const badge = document.createElement('div');
         badge.textContent = 'Aurica-Client verbunden';
         badge.style.cssText = 'position:fixed;right:10px;bottom:10px;background:#28a745;color:#fff;padding:6px 10px;border-radius:6px;font:12px/1.2 system-ui';
         document.body.appendChild(badge);
       });

       function hasApi(fnName) {
         const ok = !!(window.pywebview && window.pywebview.api && (!fnName || window.pywebview.api[fnName]));
         if (!ok) console.warn('[Aurica] Bridge fehlt oder Methode nicht vorhanden:', fnName, window.pywebview);
         return ok;
       }

       // Bestehende Funktion (Anamnese)
       async function sendToT2medFrom(textareaId) {
         const el = document.getElementById(textareaId);
         const txt = (el?.value || '').trim();
         if (!txt) { alert('Kein Text.'); return; }

         if (!hasApi('paste_to_t2med')) { alert('Native Steuerung nicht verf√ºgbar. Bitte Aurica Client-App pr√ºfen.'); return; }

         try {
           const res = await window.pywebview.api.paste_to_t2med(txt, 'T2med');
           console.log('[Aurica] paste_to_t2med ‚Üí', res);
           if (!res || !res.ok) alert('Native Steuerung fehlgeschlagen: ' + (res?.error || 'unbekannt'));
         } catch (e) {
           console.error(e);
           alert('Native Steuerung Fehler: ' + (e.message || e));
         }
       }

       // NEU: Befund/Therapie (modusgesteuert)
       async function sendToT2medMode(textareaId, mode){
         const el  = document.getElementById(textareaId);
         const txt = (el?.value || '').trim();
         if (!txt) { alert('Kein Text.'); return; }

         if (!hasApi('paste_to_t2med_mode')) { alert('Diese Funktion erfordert die aktuelle Aurica Client-App.'); return; }

         try {
           const res = await window.pywebview.api.paste_to_t2med_mode(txt, mode, 'T2med');
           console.log('[Aurica] paste_to_t2med_mode(', mode, ') ‚Üí', res);
           if (!res || !res.ok) alert('Native Steuerung fehlgeschlagen: ' + (res?.error || 'unbekannt'));
         } catch(e) {
           console.error(e);
           alert('Native Steuerung Fehler: ' + (e.message || e));
         }
       }
</script>
</body>
</html>

