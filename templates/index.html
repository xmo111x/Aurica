<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Anamnese</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      background-color: #f5f7fa;
    }

    .sidebar {
      width: 220px;
      background-color: #dfe6ec;
      padding: 20px;
      height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .sidebar h3 {
      margin-top: 0;
    }

    .sidebar a {
      display: block;
      margin: 8px 0;
      color: #007acc;
      text-decoration: none;
    }

    .sidebar a:hover {
      text-decoration: underline;
    }

    .main {
      flex-grow: 1;
      padding: 40px;
    }

    h1 {
      color: #2c3e50;
    }

    button {
      padding: 10px 20px;
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 20px;
    }

    button:hover {
      background-color: #005fa3;
    }

    input[type="file"] {
      margin-top: 10px;
    }

    form {
      margin-top: 20px;
    }

    #status {
      margin-top: 10px;
      color: #666;
    }

    /* Live-Transkription */
    .streaming-section {
      margin: 35px 0;
      padding: 20px;
      background: #e7f0fd;
      border-radius: 8px;
      border: 1px solid #b3cee9;
    }

    .streaming-section button {
      background: #007acc;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      margin-bottom: 10px;
      cursor: pointer;
      font-size: 15px;
    }

    .streaming-section button:active {
      background: #005fa3;
    }

    #liveTranscript {
      font-family: monospace;
      font-size: 16px;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-y: auto;
      height: calc(1.5em * 4 + 24px); /* 4 Zeilen + Padding */
      background: #fff;
      border: 1px solid #b3cee9;
      border-radius: 6px;
      padding: 12px;
      position: relative;
      box-sizing: border-box;
    }

    #liveTranscript::after {
      content: '|';
      animation: blink 1s infinite;
      margin-left: 4px;
      opacity: 0.6;
      position: absolute;
      bottom: 12px;
    }

    @keyframes blink {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 0; }
    }

    #liveAnamnese {
      background: #fff7cc;
      border: 1px solid #e2c960;
      padding: 12px;
      border-radius: 6px;
      min-height: 80px;
      margin-top: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  {% include "sidebar.html" %}

  <div class="main" style="margin-left: 220px;">
    <a href="/settings">‚öôÔ∏è Einstellungen</a>
    <h1>ü©∫ Anamnese</h1>

  <div id="quickModelPicker" style="margin:8px 0 16px 0; padding:8px; border:1px dashed #cbd5e1; border-radius:8px; background:#f8fafc;">
    <label for="ggmlModelSelect">Modell:</label>
    <select id="ggmlModelSelect" style="min-width:280px;"></select>
    <button type="button" id="saveModelBtn">Setzen</button>
    <small id="coremlHint" style="margin-left:8px; color:#666;"></small>
    <small id="modelStatus" style="margin-left:8px; color:#007acc;"></small>
  </div>

  <script>
(async function() {
    async function refreshModels() {
      const sel = document.getElementById('ggmlModelSelect');
      const hint = document.getElementById('coremlHint');
      const status = document.getElementById('modelStatus');
      sel.innerHTML = '<option>‚è≥ L√§dt‚Ä¶</option>';
      hint.textContent = '';
      status.textContent = '';

      let data;
      try {
        const res = await fetch('/models');
        data = await res.json();
      } catch (e) {
        sel.innerHTML = '<option>Fehler beim Laden</option>';
        status.textContent = '‚ùå /models nicht erreichbar';
        return;
      }
      sel.innerHTML = '';
      let current = data.current || '';
      (data.models || []).forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.path;
        opt.textContent = m.name + (m.has_coreml ? '  (CoreML ‚úì)' : '');
        if (m.path === current) opt.selected = true;
        sel.appendChild(opt);
      });

      if (!sel.value && data.models && data.models.length) {
        sel.value = data.models[0].path;
      }
      // CoreML-Hinweis
      const chosen = (data.models || []).find(x => x.path === sel.value);
      hint.textContent = chosen && chosen.has_coreml ? 'CoreML-Encoder vorhanden' : 'kein CoreML-Encoder gefunden';
    }

    document.getElementById('ggmlModelSelect')?.addEventListener('change', (e) => {
      const opt = e.target.selectedOptions[0];
      const text = opt?.textContent || '';
      const hasCoreML = /CoreML ‚úì/.test(text);
      document.getElementById('coremlHint').textContent = hasCoreML ? 'CoreML-Encoder vorhanden' : 'kein CoreML-Encoder gefunden';
    });

    document.getElementById('saveModelBtn')?.addEventListener('click', async () => {
      const sel = document.getElementById('ggmlModelSelect');
      const status = document.getElementById('modelStatus');
      status.textContent = '‚è≥ Speichere‚Ä¶';
      try {
        const fd = new FormData();
        fd.append('model_path', sel.value);
        const res = await fetch('/set_model', { method: 'POST', body: fd });
        const j = await res.json();
        if (j.ok) status.textContent = '‚úÖ Modell gesetzt';
        else status.textContent = '‚ùå ' + (j.error || 'Unbekannter Fehler');
      } catch (e) {
        status.textContent = '‚ùå Speichern fehlgeschlagen';
      }
    });

    await refreshModels();
  })();
</script>
  

    <!-- Live-Streaming-Transkription (Classic entfernt) -->
    <div id="liveTranskriptBlock" class="streaming-section" style="">
      <h2>üî¥ Live-Transkription (Beta)</h2>

      <!-- Mikrofon-Auswahl: LIVE -->
      <div style="margin-bottom:10px;">
        <label for="micSelect">üéôÔ∏è Mikrofon (Live):</label>
        <select id="micSelect" style="min-width:280px;"></select>
      </div>

      <button id="liveRecordBtn">üéôÔ∏è Aufnahme starten</button>
      <button id="liveStopBtn" disabled>‚èπÔ∏è Aufnahme stoppen</button>
      <span id="liveStatus" style="margin-left:15px; color: #007acc;"></span>
      <pre id="liveTranscript">Live-Transkript erscheint hier‚Ä¶</pre>

      <!-- Zusammenfassung (editierbar) -->
      <div id="liveAnamnese" contenteditable="true">
        Zusammenfassung erscheint hier‚Ä¶
      </div>

      <!-- Buttons f√ºr Speichern und Kopieren -->
      <div style="margin-top: 10px;">
        <button onclick="saveAnamnese()">üíæ Speichern</button>
        <button onclick="copyAnamneseToClipboard()">üìã Kopieren</button>
      </div>
    </div>

    <h2>üé§ Mikrofonaufnahme (klassisch)</h2>

    <!-- Mikrofon-Auswahl: KLASSISCH -->
    <div style="margin-bottom:10px;">
    <h2>üìÅ Datei-Upload</h2>
    <form method="POST" enctype="multipart/form-data">
      <label for="audiofile">WAV/MP3-Datei ausw√§hlen:</label>
      <input type="file" id="audiofile" name="audiofile" accept=".wav,.mp3" required>
      <button type="submit">üîç Analysieren</button>
    </form>
    

  </div>
<script src="{{ url_for('static', filename='record.js') }}"></script>
</body>
</html>
